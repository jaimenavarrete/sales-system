@model CreateSaleViewModel
@{
    ViewBag.Title = "Realizar venta";
}

<div class="page-title">
    <a href="@Url.Action("Index", "Sales")" class="btn btn-link">
        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> Regresar
    </a>
    <h2> <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> @ViewBag.Title</h2>
</div>
<ol class="breadcrumb">
    <li>@Html.ActionLink("Inicio", "Index", "Home")</li>
    <li>@Html.ActionLink("Ventas", "Index", "Sales")</li>
    <li class="active">@ViewBag.Title</li>
</ol>

@{ Html.RenderPartial("_ResultMessage"); }

<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title">Información de venta</h3>
    </div>
    <div class="panel-body">
        @using (Html.BeginForm("CreateSale", "Sales", FormMethod.Post, new { id = "CreateSaleForm" }))
        {
            @Html.AntiForgeryToken()

            <div class="row">
                <div class="form-group col-md-6">
                    @Html.LabelFor(m => m.ClientId)
                    @Html.DropDownListFor(m => m.ClientId, Model.ClientsList, new { @class = "form-control" })
                    @Html.ValidationMessageFor(m => m.ClientId, null, new { @class = "text-danger" })
                </div>
            </div>

            <div class="row">
                <div class="form-group col-md-6">
                    @Html.LabelFor(m => m.Observation)
                    @Html.TextAreaFor(m => m.Observation, new { @class = "form-control", rows = "3" })
                    @Html.ValidationMessageFor(m => m.Observation, null, new { @class = "text-danger" })
                </div>
            </div>

            <div class="row">
                <div class="form-group col-md-3">
                    @Html.LabelFor(m => m.IsHomeDelivery)
                    @Html.CheckBoxFor(m => m.IsHomeDelivery, new { @class = "checkbox" })
                    @Html.ValidationMessageFor(m => m.IsHomeDelivery, null, new { @class = "text-danger" })
                </div>
                <div class="form-group col-md-3">
                    @Html.LabelFor(m => m.IsPaymentCompleted)
                    @Html.CheckBoxFor(m => m.IsPaymentCompleted, new { @class = "checkbox" })
                    @Html.ValidationMessageFor(m => m.IsPaymentCompleted, null, new { @class = "text-danger" })
                </div>
            </div>

            <hr />

            <div class="add-sale-product">
                <h4><span class="glyphicon glyphicon-inbox"></span> Listado de productos</h4>

                <div class="row sale-product">
                    <div class="form-group col-lg-5">
                        @Html.Label("Producto")
                        @Html.DropDownList("ProductInput", Model.ProductsList, null, new { @class = "form-control" })
                    </div>
                    <div class="form-group col-lg-2">
                        @Html.Label("Cantidad")
                        @Html.TextBox("QuantityInput", null, new { @class = "form-control", type = "number" })
                    </div>
                    <div class="form-group col-lg-2">
                        @Html.Label("Descuento")
                        @Html.TextBox("DiscountInput", null, new { @class = "form-control", type = "number" })
                    </div>
                    <div class="action-buttons col-lg-3">
                        <button id="AddSaleProduct" type="button" class="btn btn-success">
                            <span class="glyphicon glyphicon-plus"></span>
                        </button>
                    </div>
                </div>
            </div>

            @* Sale Products List *@
            <div id="SaleProductsList" class="sale-products-list">

            </div>
        }
    </div>
    <div class="panel-footer text-center">
        <button class="btn btn-success" form="CreateSaleForm">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Crear
        </button>
        <button type="reset" class="btn btn-default" form="CreateSaleForm">
            <span class="glyphicon glyphicon-erase" aria-hidden="true"></span> Limpiar
        </button>
    </div>
</div>

@section scripts
{
    @Styles.Render("~/Content/jquery-confirm")
    @Scripts.Render("~/bundles/jquery-confirm")

<script>

        var addSaleProductButton = $("#AddSaleProduct");
        var saleProductsList = $("#SaleProductsList");
        var createSaleForm = $("#CreateSaleForm");

        addSaleProductButton.on('click', addProductSale);

        function addProductSale() {
            var productId = createSaleForm.find('[name = "ProductInput"]').val();
            var quantity = createSaleForm.find('[name = "QuantityInput"]').val();
            var discount = createSaleForm.find('[name = "DiscountInput"]').val();

            if (!isValidData(productId, quantity, discount)) {
                return;
            }

            getProductData(productId, function (productData) {
                if (discount > productData.Price) {
                    showErrorMessage("El descuento no puede ser mayor al precio del producto. Precio actual: $" + productData.Price);
                    return;
                }

                var saleProductElement = createSaleProductElement(productData, quantity, discount);
                saleProductsList.append(saleProductElement);
            });
        }

        function isValidData(productId, quantity, discount) {
            // Validate existence
            if (!productId) {
                showErrorMessage("Debe seleccionar un producto.")
                return false;
            }

            if (!quantity) {
                showErrorMessage("Debe colocar la cantidad a vender.")
                return false;
            }

            var searchSaleProductById = $("#ProductSale-" + productId);

            if (searchSaleProductById.length > 0) {
                showErrorMessage("El producto que ha seleccionado ya existe en la lista.")
                return false;
            }

            // Reject negative values
            if (quantity < 0) {
                showErrorMessage("La cantidad no puede ser negativa.")
                return false;
            }

            if (discount < 0) {
                showErrorMessage("El descuento no puede ser negativo.")
                return false;
            }

            return true;
        }

        function getProductData(productId, callback) {
            var url = "@Url.Action("GetProductById", "Data")";

            $.ajax({
                url,
                data: { id: productId },
                type: 'GET',
                dataType: 'json',
                error: function (error) {
                    showErrorMessage("El producto que ha seleccionado no existe.")
                },
                success: callback
            })
        }

        function createSaleProductElement(productData, quantity, discount) {
            var total = (productData.Price - discount) * quantity;

            var saleProductElement = $(`
                <div id="ProductSale-${productData.Id}" class="row sale-product">
                    <div class="form-group col-lg-5">
			            <label>Producto</label>
                        <select name="ProductId" class="form-control" disabled="true">
                            <option value="${productData.Id}">${productData.Id}. ${productData.Name} - ${productData.UnitTypeName}<option>
                        <select>
                    </div>
                    <div class="form-group col-lg-2">
                        <label>Cantidad</label>
                        <input name="Quantity" type="number" class="form-control" value="${quantity}" />
                    </div>
                    <div class="form-group col-lg-2">
                        <label>Descuento</label>
                        <input name="Discount" type="number" class="form-control" value="${discount ? discount : 0}" />
                    </div>
                    <div class="form-group col-lg-1">
                        <label>Precio</label>
                        <input type="text" class="form-control" disabled="true" value="$${productData.Price}" />
                    </div>
                    <div class="form-group col-lg-1">
                        <label>Total</label>
                        <input type="text" class="form-control" disabled="true" value="$${total}" />
                    </div>
                    <div class="action-buttons col-lg-1">
                        <button type="button" class="btn btn-danger">
                            <span class="glyphicon glyphicon-trash"></span>
                        </button>
                    </div>
                </div>
            `);

            return saleProductElement;
        }

        function showErrorMessage(message) {
            $.alert({
                icon: 'glyphicon glyphicon-exclamation-sign',
                title: 'Error!',
                content: message,
                type: 'red',
                backgroundDismiss: true
            });
        }

</script>
}